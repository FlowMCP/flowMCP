# FlowMCP Spec

## Schema Metadata

```json
{
  "name": "string",
  "description": "string",
  "version": "x.y.z",
  "flowMCP": "x.y.z",
  "root": "https://your-api-root.com",
  "requiredServerParams": ["ENV_VAR_1", "ENV_VAR_2"],
  "headers": {},
  "routes": { ... },
  "handlers": { ... }
}
```

- `version` and `flowMCP` must follow semantic versioning (`x.y.z`)
- `root` must be a valid URL
- `requiredServerParams` refers to environment variables used via `{{ENV_VAR}}` in the schema

---

## Route Structure

### Example Route

```json
{
  "requestMethod": "GET",
  "description": "Route description",
  "route": "/api",
  "parameters": [
    { "position": { "key": "module", "value": "contract", "location": "query" } },
    { "position": { "key": "address", "value": "{{USER_PARAM}}", "location": "query" }, "z": { "primitive": "string", "options": ["min(42)", "max(42)"] } }
  ],
  "tests": [
    { "_description": "A test case", "address": "0x..." }
  ],
  "modifiers": [
    { "phase": "post", "handler": "convertToJSON" }
  ]
}
```

#### Valid `requestMethod` values
- `"GET"`
- `"POST"`

#### `position.location` options
- `"body"`
- `"query"`
- `"insert"` (for URL path variables like `:userId`)

#### `z` validation schema
- `primitive`: `"string"`, `"number"`, `"boolean"`, `"object"`
- `options` (examples):
  - `"min(10)"`
  - `"max(100)"`
  - `"length(42)"`
  - `"regex(^0x[a-fA-F0-9]{40}$)"`
  - `"enum(val1,val2)"`
  - `"optional()"`
  - `"default(value)"`

---

## Tests

```json
[
  {
    "_description": "Test description",
    "param1": "value",
    "param2": "value"
  }
]
```

- Only parameters marked as `{{USER_PARAM}}` need to be defined in test cases.
- Keys without `_` prefix must match the declared parameters in `parameters`.
- `_description` is mandatory.

---

## Handler Functions

Handlers can be used as `pre` or `post` modifiers.

```js
handlers: {
  convertToJSON: async ({ struct, payload }) => {
    if (struct['data'].status !== "1") {
      struct['status'] = false;
      struct['messages'].push(struct.data.message);
      return { struct, payload };
    }
    struct['data'] = struct['data'].result;
    return { struct, payload };
  }
}
```

#### Usage in `modifiers`:

```json
[
  {
    "phase": "post",
    "handler": "convertToJSON"
  }
]
```

---

## Validation & Error Handling

The `Validation` class verifies:
- Schema metadata structure
- Route definitions
- Completeness and correctness of `parameters`, `modifiers`, and `tests`
- Existence and validity of `{{USER_PARAM}}` definitions
- Consistency between required and allowed parameters

---

## Dynamic Placeholders

```text
{{USER_PARAM}}  → provided at runtime by the user  
{{ENV_VAR}}     → resolved at runtime from the server (e.g., process.env)
```